document.addEventListener("DOMContentLoaded", () => {
  let btcPrice = 0; // Store the latest BTC price in USD

  async function updateUSD() {
    const usdCells = document.querySelectorAll("#satoshiTable .usd");
    const countdownElement = document.getElementById("countdown");

    try {
      const response = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd");
      if (!response.ok) {
        throw new Error("Failed to fetch Bitcoin price");
      }
      const data = await response.json();
      btcPrice = data.bitcoin.usd; // Update the global BTC price

      const rows = document.querySelectorAll("#satoshiTable tbody tr");
      rows.forEach((row, index) => {
        const btcAmount = parseFloat(row.cells[0].textContent);
        const usdValue = btcAmount * btcPrice;
        usdCells[index].textContent = "$" + usdValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        usdCells[index].classList.remove('highlight');
        setTimeout(() => {
          usdCells[index].classList.add('highlight');
          console.log("Highlight added to index:", index);
        }, 10);
      });

    } catch (error) {
      console.error("Error updating USD values:", error.message);
      usdCells.forEach(cell => {
        cell.textContent = "Error: Check connection";
        cell.style.color = "#FF4444";
      });
    } finally {
      startCountdown(60, countdownElement);
    }
  }

  function startCountdown(seconds, element) {
    if (!element) return;
    element.textContent = `Next update in ${seconds} seconds`;
    const countdown = setInterval(() => {
      seconds--;
      if (seconds >= 0) {
        element.textContent = `Next update in ${seconds} seconds`;
      } else {
        clearInterval(countdown);
      }
    }, 1000);
  }

  // Conversion functions
  function satsToBtc(sats) {
    return sats / 100000000; // 100 million Satoshis = 1 BTC
  }

  function btcToSats(btc) {
    return btc * 100000000;
  }

  function btcToUsd(btc) {
    return btc * btcPrice;
  }

  function usdToBtc(usd) {
    return usd / btcPrice;
  }

  // Handle input changes
  const satsInput = document.getElementById("sats-input");
  const btcInput = document.getElementById("btc-input");
  const usdInput = document.getElementById("usd-input");

  satsInput.addEventListener("input", () => {
    const sats = parseFloat(satsInput.value) || 0;
    const btc = satsToBtc(sats);
    const usd = btcToUsd(btc);
    btcInput.value = btc.toFixed(8); // 8 decimals for BTC
    usdInput.value = usd.toFixed(2); // 2 decimals for USD
  });

  btcInput.addEventListener("input", () => {
    const btc = parseFloat(btcInput.value) || 0;
    const sats = btcToSats(btc);
    const usd = btcToUsd(btc);
    satsInput.value = sats.toFixed(0); // No decimals for Satoshis
    usdInput.value = usd.toFixed(2);
  });

  usdInput.addEventListener("input", () => {
    const usd = parseFloat(usdInput.value) || 0;
    const btc = usdToBtc(usd);
    const sats = btcToSats(btc);
    btcInput.value = btc.toFixed(8);
    satsInput.value = sats.toFixed(0);
  });

  updateUSD();
  setInterval(updateUSD, 60000);
});